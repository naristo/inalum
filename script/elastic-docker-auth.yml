version: '2.2'
services:
  es-master-01:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    user: root
    container_name: es-master-01
    environment:
      - node.name=es-master-01
      - cluster.name=es-siem-cluster
      - discovery.seed_hosts=es-master-02,es-master-03
      - cluster.initial_master_nodes=es-master-01,es-master-02,es-master-03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms${ES_JVM_HEAP} -Xmx${ES_JVM_HEAP}"
      - xpack.license.self_generated.type=trial
      - xpack.security.enabled=true
    mem_limit: ${ES_MEM_LIMIT}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data-01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
    networks:
      - elastic

  es-master-02:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: es-master-02
    user: root
    environment:
      - node.name=es-master-02
      - cluster.name=es-siem-cluster
      - discovery.seed_hosts=es-master-01,es-master-03
      - cluster.initial_master_nodes=es-master-01,es-master-02,es-master-03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms${ES_JVM_HEAP} -Xmx${ES_JVM_HEAP}"
      - xpack.license.self_generated.type=trial
      - xpack.security.enabled=true
    mem_limit: ${ES_MEM_LIMIT}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data-02:/usr/share/elasticsearch/data
    ports:
      - 9201:9201
    networks:
      - elastic

  es-master-03:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: es-master-03
    user: root
    environment:
      - node.name=es-master-03
      - cluster.name=es-siem-cluster
      - discovery.seed_hosts=es-master-01,es-master-02
      - cluster.initial_master_nodes=es-master-01,es-master-02,es-master-03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms${ES_JVM_HEAP} -Xmx${ES_JVM_HEAP}"
      - xpack.license.self_generated.type=trial
      - xpack.security.enabled=true
    mem_limit: ${ES_MEM_LIMIT}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data-03:/usr/share/elasticsearch/data
    ports:
      - 9202:9202
    networks:
      - elastic

  kibana-01:
    image: docker.elastic.co/kibana/kibana:${KIBANA_VERSION}
    container_name: kibana-01
    ports:
      - 5601:5601
    environment:
      ELASTICSEARCH_URL: http://es-master-01:9200
      ELASTICSEARCH_HOSTS: http://es-master-01:9200
      ELASTICSEARCH_USERNAME: kibana
      ELASTICSEARCH_PASSWORD: 8EZZ0VbPI26AO9kvzFE8 
    networks:
      - elastic
  logstash-01:
    image: docker.elastic.co/logstash/logstash:${LOGSTASH_VERSION}
    container_name: logstash-01
    ports:
      - 9600:9600
      - 5401:5401
      - 5402:5402
      - 5403:5403
      - 5404:5404
      - 5405:5405
      - 5406:5406
      - 5407:5407
      - 5408:5408
      - 5409:5409
      - 5410:5410
      - 5411:5411
    environment:
      LS_JAVA_OPTS: "-Xmx${LS_JVM_HEAP} -Xms${LS_JVM_HEAP}"
      #ELASTICSEARCH_URL: http://es-master-01:9200
      #ELASTICSEARCH_HOSTS: http://es-master-01:9200
      #ELASTICSEARCH_USERNAME: logstash_system
      #ELASTICSEARCH_PASSWORD: 0qejE6zzTsl4wb0pzsRN
    volumes:
      - ./logstash/pipeline/:/usr/share/logstash/pipeline/
      - ./logstash/config/:/usr/share/logstash/config/
    networks:
      - elastic

#volumes:
#  data-01:
#    driver: local
#  data-02:
#    driver: local
#  data-03:
#    driver: local
    
volumes:
  data-01:
    driver: local-persist
    driver_opts:
      mountpoint: /data/es/data-01
  data-02:
    driver: local-persist
    driver_opts:
      mountpoint: /data/es/data-01
  data-03:
    driver: local-persist
    driver_opts:
      mountpoint: /data/es/data-01
networks:
  elastic:
    driver: bridge
